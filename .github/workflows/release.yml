name: Create new release from release branch

# This action will only run when a pull request is closed/merged.
on:
  pull_request:
    types:
      - closed

jobs:
  create-release:
    # Action will be skipped unless we have a successful merge AND the original PR started with release
    # If this condition isn't matched, then github will show the action as skipped. 
    if:  startsWith(github.head_ref, 'release') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - run: echo "A release branch has been merged with trunk, time to create a new release"
      - name: Checkout
        uses: actions/checkout@v3
        with:
          # We checkout based on the merge_commit_sha trunk so we're acting on post-merge state rather than pre-merge.
          ref: ${{github.event.pull_request.merge_commit_sha}}
      - name: Get Version
        id: version
        run: echo ::set-output name=data::$(date "+%s")
      - name: Get Changelog
        id: changelog
          # multiline strings aren't supported well in github actions. The first line below is to 
          # save the changelog into a local variable, the other lines are post-processing required
          # for saving this. see https://medium.com/agorapulse-stories/how-to-work-with-multiline-string-variables-in-github-actions-23f56447d209
        run: |
          export CHANGELOG="$(ls -l)"
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "::set-output name=data::$(echo "$CHANGELOG")"

        # The following are just for debugging purposes
      - name: Echo version
        run: echo ${{steps.version.outputs.data}}
      - name: Echo changelog 
        run: echo ${{steps.changelog.data}}
        
        
      - name: Release
        uses: softprops/action-gh-release@v0.1.14
        with:
          tag_name: ${{steps.version.outputs.data}}
          name: "Version ${{steps.version.outputs.data}}"
          body: ${{steps.changelog.data}}
          target_commitish: ${{github.event.pull_request.merge_commit_sha}}